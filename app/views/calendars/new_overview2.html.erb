<div id="new_guide_overview_page">

  <h1>Step 3)Schedule your points of interest over the week</h1>

  <h2> Your guide: <%= h(params[:calendar_name_location]) + ' for ' + h(params[:calendar_name_target]) %> </h2>

  <div id="place-pool">
    <% @places.each do |place| %>
        <div class="place-tag">
          <a title="edit" href="javascript:"><%= h place %></a>
          <input type="text" style="display:none" value="<%= h place %>" maxlength="25" autocomplete="off">
        </div>
    <% end %>
  </div>
    <div style="position:relative;top:-90px;left:475px;height:10px"><img src="/images/arrowcurve.png">    
    <div id=1 style="position:relative;top:-180px;left:100px;font-size:30px;"> Drag your<BR> points of interest<BR> over the weekday slots</div>
</div></div>

Choose between "Simple" and "Full" weekday matrix.<BR> Simple has 4 schedules per weeekday, Full has 11.  <ul class="guide-type-tabs">
    <% GuideType.all.each do |guide_type| %>
        <li><a href=""><%= guide_type.name %></a></li>
    <% end %>
  </ul>

  <div class="guide-type-panes">
    <% GuideType.all.each do |guide_type| %>
        <div>
          <form action="<%= create_guide_path %>" method="POST">
            <input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>"/>
            <input name="step" type="hidden" value="overview">

            <input type="hidden" name="calendar_name_location" value="<%= params[:calendar_name_location] %>">
            <input type="hidden" name="calendar_name_target" value="<%= params[:calendar_name_target] %>">
            <input type="hidden" name="location_code" value="<%= params[:location_code] %>">
            <input type="hidden" name="location_name" value="<%= params[:location_name] %>">
            <input type="hidden" name="guide_type_id" value="<%= guide_type.id %>">


            <div class="selected-tips">
              <div class="table-row">
                <div class="table-cell table-label"></div>
                <% @weekdays.each do |day| %>
                    <div class="table-cell table-label">
                      <%= day.name %>
                    </div>
                <% end %>
              </div>
              <% guide_type.conditions.each do |condition| %>
                  <div class="table-row">
                    <div class="table-cell table-label">
                      <%= condition.full_name %>
                    </div>
                    <% @weekdays.each do |day| %>
                        <div class="table-cell placeholder" condition_id="<%=condition.id%>" weekday_id="<%=day.id%>"></div>
                    <% end %>
                  </div>
              <% end %>
            </div>
<BR>  <img src="/images/exclama.png" width="33" height="65" align="left" /><BR>You can add more <BR>Points of Interest by <BR>clicking on each slot. 

            <div class="button-panel">
              <a href="javascript:" onclick="$(this).parents('form').submit();" class="button">
                Proceed to Step 4: Add details to your Points of Interest;
              </a>
            </div>

          </form>

        </div>
    <% end %>
  </div>



</div>


<script>
    $(document).ready(function() {
        $("ul.guide-type-tabs").fpTabs("div.guide-type-panes > div");

//        var root = $('#new_guide_overview_page');

        function initTags(root) {
            var tags;
            if (root.hasClass('place-tag')) {
                tags = root;
            } else {
                tags = root.find('.place-tag');
            }

            // edit tag
            tags.find('a').click(function() {
                $(this).hide();
                $(this).parent().find('input').show().focus();
            });
            tags.find('input').blur(function() {
                var val = $(this).val();
                if (common.trim(val) == '') {
                    $(this).parent().remove();
                    return;
                }
                $(this).hide();
                $(this).parent().find('a').text(val).show();
            }).keypress(function(e) {
                if(e.which == 13) {
                    $(this).blur();
                    return false;
                }
            });

            // drag'n'drop
            tags.draggable({
                revert: 'invalid',
                helper: 'clone'
            });
        }
        initTags($('#place-pool'));


        $('#place-pool').droppable({
            accept: ".place-tag",
            hoverClass: 'droppable-active',
            drop: function(ev, ui) {
                var place = $(this);
                ui.draggable.appendTo(place);
                ui.draggable.css('left', 0).css('top', 0);
            }
        });

        function addTag(place, tag) {
            var condition_id = place.attr('condition_id');
            var weekday_id = place.attr('weekday_id');
            if (condition_id != null && weekday_id != null) {
                tag.find('input').attr('name', 'tip_name[' + condition_id + '][' + weekday_id + ']');
            }
            place.append(tag);
        }
        $('div.selected-tips .placeholder').droppable({
            accept: ".place-tag",
            hoverClass: 'droppable-active',
            drop: function(ev, ui) {
                var place = $(this);
                if (place.find('.place-tag').length > 0) {
                    // switch places
                    addTag(ui.draggable.parent(), place.find('.place-tag'));
//                    place.find('.place-tag').appendTo(ui.draggable.parent());
                }
                addTag(place, ui.draggable);
//                ui.draggable.appendTo(place);
                ui.draggable.css('left', 0).css('top', 0);
            }
        });
        $('div.selected-tips .placeholder').click(function() {
            if (common.trim($(this).html()) != '') {
                return;
            }
            var tag = $('<div></div>').addClass('place-tag');
            tag.append($('<a></a>').attr('href', 'javascript:').attr('title', 'edit').hide());
            tag.append($('<input>').attr('type', 'text').attr('maxlength', 25).attr('autocomplete', 'off'));
            $(this).append(tag);
            initTags(tag);
            tag.find('input').focus();
        });
    });
</script>